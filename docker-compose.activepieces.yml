version: "3.9"

services:
  activepieces:
    image: activepieces/activepieces:latest
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.activepieces.rule=Host(`automate.wickedlab.io`)"
      - "traefik.http.routers.activepieces.entrypoints=http,https"
      - "traefik.http.routers.activepieces.tls=true"
      - "traefik.http.routers.activepieces.tls.certresolver=letsencrypt"
      - "traefik.http.services.activepieces.loadbalancer.server.port=80"
    environment:
      AP_EDITION: "ce"
      AP_ENVIRONMENT: "prod"
      AP_FRONTEND_URL: "${AP_FRONTEND_URL}"
      AP_EXECUTION_MODE: "UNSANDBOXED"
      AP_DB_TYPE: "POSTGRES"
      AP_REDIS_TYPE: "STANDALONE"
      AP_POSTGRES_HOST: "postgres"
      AP_POSTGRES_PORT: "5432"
      AP_POSTGRES_USERNAME: "${AP_POSTGRES_USERNAME}"
      AP_POSTGRES_PASSWORD: "${AP_POSTGRES_PASSWORD}"
      AP_POSTGRES_DATABASE: "${AP_POSTGRES_DATABASE}"
      AP_REDIS_HOST: "redis"
      AP_REDIS_PORT: "6379"
      AP_JWT_SECRET: "${AP_JWT_SECRET}"
      AP_ENCRYPTION_KEY: "${AP_ENCRYPTION_KEY}"
      AP_DEV_PIECES: "${AP_DEV_PIECES:-bcgpt,basecamp}"
      AP_CONFIG_PATH: "/var/data/activepieces"
    volumes:
      - ap-dev-piece-bcgpt:/usr/src/app/dist/packages/pieces/community/bcgpt
      - ap-dev-piece-basecamp:/usr/src/app/dist/packages/pieces/community/basecamp
      - activepieces-data:/var/data/activepieces
    expose:
      - "80"
    depends_on:
      - postgres
      - redis

  pieces-builder:
    image: node:20-bullseye
    working_dir: /repo-src
    environment:
      GIT_REPO_URL: "https://github.com/wickeddevsupport/bcgpt.git"
      GIT_REPO_REF: "main"
    volumes:
      - ap-dev-repo:/repo-src
      - ap-dev-piece-bcgpt:/repo-dist/bcgpt
      - ap-dev-piece-basecamp:/repo-dist/basecamp
    command: >
      bash -lc "
        set -e;
        apt-get update && apt-get install -y git curl;
        if [ ! -d /repo-src/.git ]; then
          rm -rf /repo-src/* /repo-src/.[!.]* /repo-src/..?* || true;
          git clone --depth=1 $$GIT_REPO_URL /repo-src;
        fi;
        git -C /repo-src fetch origin $$GIT_REPO_REF --depth=1 || true;
        git -C /repo-src reset --hard origin/$$GIT_REPO_REF;
        cd /repo-src/activepieces;
        curl -fsSL https://bun.sh/install | bash;
        export PATH=/root/.bun/bin:$PATH;
        bun install;
        npx nx build pieces-bcgpt pieces-basecamp;
        rm -rf /repo-dist/bcgpt/* /repo-dist/basecamp/* || true;
        cp -a /repo-src/activepieces/dist/packages/pieces/community/bcgpt/. /repo-dist/bcgpt/;
        cp -a /repo-src/activepieces/dist/packages/pieces/community/basecamp/. /repo-dist/basecamp/;
        sleep infinity
      "

  postgres:
    image: postgres:15
    environment:
      POSTGRES_USER: "${AP_POSTGRES_USERNAME}"
      POSTGRES_PASSWORD: "${AP_POSTGRES_PASSWORD}"
      POSTGRES_DB: "${AP_POSTGRES_DATABASE}"
    volumes:
      - postgres-data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    volumes:
      - redis-data:/data

volumes:
  activepieces-data:
    external: true
    name: activepieces-data
  postgres-data:
    external: true
    name: activepieces-postgres-data
  redis-data:
    external: true
    name: activepieces-redis-data
  ap-dev-repo:
    external: true
    name: ap-dev-repo
  ap-dev-piece-bcgpt:
    external: true
    name: ap-dev-piece-bcgpt
  ap-dev-piece-basecamp:
    external: true
    name: ap-dev-piece-basecamp
