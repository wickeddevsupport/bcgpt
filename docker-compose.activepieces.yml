services:
  activepieces:
    image: ghcr.io/wickeddevsupport/activepieces-bcgpt:latest
    env_file:
      - .env.activepieces
    labels:
      - "traefik.enable=true"
      # Ensure Traefik uses the same network it is attached to (Coolify's `coolify` network).
      - "traefik.docker.network=coolify"
      - "traefik.http.middlewares.activepieces-redirect-to-https.redirectscheme.scheme=https"
      - "traefik.http.routers.activepieces-http.entrypoints=http"
      - "traefik.http.routers.activepieces-http.rule=Host(`flow.wickedlab.io`)"
      - "traefik.http.routers.activepieces-http.middlewares=activepieces-redirect-to-https"
      - "traefik.http.routers.activepieces.rule=Host(`flow.wickedlab.io`)"
      - "traefik.http.routers.activepieces.entrypoints=http,https"
      - "traefik.http.routers.activepieces.tls=true"
      - "traefik.http.routers.activepieces.tls.certresolver=letsencrypt"
      - "traefik.http.services.activepieces.loadbalancer.server.port=80"
    networks:
      - activepieces
      - coolify
    environment:
      AP_EDITION: "ce"
      AP_ENVIRONMENT: "prod"
      AP_FRONTEND_URL: "${AP_FRONTEND_URL}"
      AP_EXECUTION_MODE: "UNSANDBOXED"
      AP_DB_TYPE: "POSTGRES"
      AP_REDIS_TYPE: "STANDALONE"
      # Use unique internal DNS names to avoid collisions on the shared Coolify network.
      AP_POSTGRES_HOST: "activepieces-postgres"
      AP_POSTGRES_PORT: "5432"
      AP_POSTGRES_USERNAME: "${AP_POSTGRES_USERNAME}"
      AP_POSTGRES_PASSWORD: "${AP_POSTGRES_PASSWORD}"
      AP_POSTGRES_DATABASE: "${AP_POSTGRES_DATABASE}"
      AP_REDIS_HOST: "activepieces-redis"
      AP_REDIS_PORT: "6379"
      # Must match Redis `--requirepass` below, otherwise ioredis will emit NOAUTH.
      AP_REDIS_PASSWORD: "${AP_REDIS_PASSWORD}"
      AP_JWT_SECRET: "${AP_JWT_SECRET}"
      AP_ENCRYPTION_KEY: "${AP_ENCRYPTION_KEY}"
      AP_CONFIG_PATH: "/var/data/activepieces"
      # Custom branding
      AP_APP_TITLE: "Wicked Flow"
      AP_FAVICON_URL: "https://flow.wickedlab.io/branding/wicked-flow-icon.svg"
      # Load custom pieces built in the image
      AP_DEV_PIECES: "basecamp"
    volumes:
      - activepieces-data:/var/data/activepieces
    expose:
      - "80"
    depends_on:
      - postgres
      - redis

  postgres:
    image: postgres:15
    environment:
      POSTGRES_USER: "${AP_POSTGRES_USERNAME}"
      POSTGRES_PASSWORD: "${AP_POSTGRES_PASSWORD}"
      POSTGRES_DB: "${AP_POSTGRES_DATABASE}"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      activepieces:
        aliases:
          - activepieces-postgres

  redis:
    image: redis:7-alpine
    command: >
      redis-server
      --appendonly no
      --requirepass ${AP_REDIS_PASSWORD}
    volumes:
      - redis-data:/data
    networks:
      activepieces:
        aliases:
          - activepieces-redis

volumes:
  activepieces-data:
    external: true
    name: activepieces-data
  postgres-data:
    external: true
    name: activepieces-postgres-data
  redis-data:
    external: true
    name: activepieces-redis-data

networks:
  coolify:
    external: true
  activepieces:
    internal: true
