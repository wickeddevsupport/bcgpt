version: "3.9"

services:
  pmos:
    build:
      context: ./openclaw
      dockerfile: Dockerfile
      args:
        INCLUDE_VENDORED_N8N: "true"
    environment:
      # Keep OpenClaw config/workspace in a named volume by pinning HOME into /app.
      HOME: /app
      TERM: xterm-256color

      # Required when binding to LAN (0.0.0.0) behind Traefik.
      OPENCLAW_GATEWAY_TOKEN: "${OPENCLAW_GATEWAY_TOKEN}"

      # Embedded-first behavior. Only allow remote ops provisioning if explicitly enabled.
      PMOS_ALLOW_REMOTE_OPS_FALLBACK: "${PMOS_ALLOW_REMOTE_OPS_FALLBACK:-0}"

      # Persist embedded n8n state (SQLite DB, credentials, settings) inside the OpenClaw volume.
      # Without this, n8n defaults to ~/.n8n which is not persisted in this compose.
      N8N_USER_FOLDER: "${N8N_USER_FOLDER:-/app/.openclaw/n8n}"
      # Keep permissions on n8n settings file tight (n8n will enforce/auto-fix on startup).
      N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS: "${N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS:-true}"

      # Optional model auth (add in Coolify env vars if/when needed).
      CLAUDE_AI_SESSION_KEY: "${CLAUDE_AI_SESSION_KEY:-}"
      CLAUDE_WEB_SESSION_KEY: "${CLAUDE_WEB_SESSION_KEY:-}"
      CLAUDE_WEB_COOKIE: "${CLAUDE_WEB_COOKIE:-}"
    volumes:
      - openclaw-data:/app/.openclaw
    expose:
      - "10001"
    init: true
    restart: unless-stopped
    command:
      [
        "node",
        "openclaw.mjs",
        "gateway",
        "--allow-unconfigured",
        "--bind",
        "lan",
        "--port",
        "10001"
      ]

volumes:
  openclaw-data:
    driver: local
